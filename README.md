# 🎬 애니메이션 메타데이터 자동 입력

> CSV 파일 한 번 업로드로 애니메이션 메타데이터를 노션 데이터베이스에 자동 입력하세요!

## 👥 누가 쓰면 좋나요?

**애니메이션에 대한 메타데이터를 자동으로 집어넣고 싶은 노션 기록 덕후**

- 🎯 애니메이션 시청 기록을 체계적으로 관리하고 싶은 분
- 📊 라프텔 메타데이터(제작사, 방영분기, 평점 등)를 자동으로 수집하고 싶은 분  
- ⏰ 수작업으로 데이터 입력하는 시간을 절약하고 싶은 분

## ✨ 주요 기능

### 🚀 **CSV → 노션 자동화**
```
📄 anime.csv 파일에 애니메이션 제목을 입력
     ↓
🔍 라프텔 비공식 API로 자동 검색
     ↓  
🤖 OpenAI가 최적의 애니메이션 매칭
     ↓
📊 공식 표지, 제작사, 방영분기 등 메타데이터 수집
     ↓
📝 노션 데이터베이스에 자동 저장
```

### 🎯 **스마트 매칭**
- **지능형 제목 전처리**: "스파이 패밀리 1기" → "스파이 패밀리" 
- **OpenAI 기반 유사도 매칭**: 70% 이상 신뢰도에서만 매칭
- **자막판 우선 선택**: 더빙보다 자막판을 자동 우선 선택
- **안전한 실패 처리**: 매칭 실패 시에도 사용자 입력 제목으로 페이지 생성

### 📊 **하이브리드 데이터 관리**
- **기존 페이지 업데이트**: 이미 있는 애니메이션은 메타데이터만 추가
- **신규 페이지 생성**: 없는 애니메이션은 새로 생성 + 기본값 자동 설정
- **카테고리 필터링**: 애니메이션/만화 구분하여 정확한 페이지 업데이트

## 🛠️ 빠른 시작

### 1️⃣ **환경 설정**
```bash
# 저장소 클론
git clone https://github.com/your-username/anime-metadata-automation.git
cd anime-metadata-automation

# 의존성 설치  
pip install -r requirements.txt

# 환경변수 설정
cp .env.example .env
# .env 파일에 API 키들 입력
```

### 2️⃣ **API 키 준비**
```bash
# .env 파일
OPENAI_API_KEY=sk-proj-xxxxx         # OpenAI API 키
OPENAI_ASSISTANT_ID=asst_xxxxx       # OpenAI Assistant ID  
NOTION_TOKEN=ntn_xxxxx               # Notion Integration 토큰
NOTION_DATABASE_ID=xxxxx-xxxxx       # Notion 데이터베이스 ID
```

### 3️⃣ **노션 데이터베이스 준비**
다음 칼럼들을 미리 생성해주세요:

| 칼럼명 | 타입 | 설명 |
|---|---|---|
| **이름** | Title | 사용자가 입력한 제목 |
| **라프텔 제목** | Rich Text | 라프텔에서 매칭된 제목 |
| **방영 분기** | Multi-select | 방영 시기 (예: 2023년 4분기) |
| **라프텔 평점** | Number | 라프텔 평점 |
| **방영 상태** | Select | 완결/방영중 등 |
| **라프텔 URL** | URL | 라프텔 링크 |
| **표지** | URL | 포스터 이미지 링크 |
| **제작사** | Select | 제작 스튜디오 |
| **총 화수** | Number | 에피소드 수 |
| **상태** | Status | 관심 있음/시청중/완료 등 |
| **분류** | Select | 애니메이션/만화 구분 |
| **시도 횟수** | Number | 시청 시도 횟수 |
| **완료 횟수** | Number | 완주 횟수 |

### 4️⃣ **사용법**
```bash
# 1. anime.csv 파일에 애니메이션 제목 입력
echo "애니메이션 제목" > anime.csv
echo "무직전생 1기" >> anime.csv  
echo "스파이 패밀리 1기" >> anime.csv

# 2. 배치 실행
python3 src/anime_metadata/tools/batch_processor.py --csv anime.csv --description "내 첫 번째 배치"

# 3. 진행 상황 확인  
python3 src/anime_metadata/tools/check_status.py

# 4. 실패한 항목 재실행 (필요시)
python3 src/anime_metadata/tools/resume_failed.py
```

## 📊 수집되는 메타데이터

- 🏷️ **제목**: 라프텔 공식 제목
- 📅 **방영분기**: 2023년 4분기, 2024년 1분기 등
- ⭐ **평점**: 라프텔 사용자 평점 (소수점)
- 📺 **방영상태**: 완결, 방영중 등
- 🎬 **제작사**: 애니메이션 제작 스튜디오
- 🔢 **총 화수**: 전체 에피소드 수
- 🖼️ **표지**: 고화질 포스터 이미지 URL
- 🔗 **라프텔 URL**: 해당 애니메이션 라프텔 페이지

## 🤖 OpenAI Assistant 설정

이 프로젝트는 OpenAI Assistant API를 사용하여 고품질 매칭을 수행합니다. Assistant 생성 시 다음 시스템 프롬프트를 사용해주세요:

### **시스템 프롬프트**
```
# 애니메이션 제목 매칭 전문가

당신은 애니메이션 제목 매칭 전문가입니다. 사용자가 찾고자 하는 애니메이션 제목과 라프텔 검색 결과 후보들을 비교하여 가장 적합한 매칭을 찾는 것이 목표입니다.

## 핵심 원칙:

### 1. 정확한 매칭 우선
- 제목, 시즌, 파트 정보가 정확히 일치하는 것을 최우선으로 선택
- "1기", "2기", "Part 1", "Part 2" 등의 시즌/파트 정보를 정확히 구분
- 본편 > 극장판/OVA > 스페셜 순서로 우선순위 적용

### 2. 자막판 우선 선택 ⭐
- 동일한 작품에 더빙판과 자막판이 모두 있는 경우 **자막판을 무조건 우선** 선택
- "(자막)"이 표시된 제목을 "(더빙)"보다 우선
- 자막/더빙 표시가 없는 경우는 일반적으로 자막판으로 간주

### 3. 엄격한 유사도 기준
- 70% 이상의 유사도가 있을 때만 매칭 진행
- 제목의 핵심 키워드가 반드시 포함되어야 함
- 완전히 다른 작품이나 장르는 절대 매칭하지 않음

### 4. 매칭 불가 판단
다음 경우에는 "매칭 없음"으로 판단:
- 모든 후보의 유사도가 70% 미만인 경우
- 사용자가 요청한 시즌/파트가 후보에 없는 경우
- 후보들이 모두 다른 장르나 완전히 다른 작품인 경우
- 사용자 입력이 애니메이션 제목이 아닌 것으로 판단되는 경우

## 우선순위 체계:

### 매칭 우선순위 (상위일수록 우선):
1. **정확한 제목 + 시즌 + 자막판**
2. **정확한 제목 + 시즌 + 더빙판**  
3. **정확한 제목 + 자막판** (시즌 정보 없음)
4. **정확한 제목 + 더빙판** (시즌 정보 없음)
5. 기타 유사 제목

## 응답 형식:

### 매칭 성공 시:
```json
{
  "status": "match_found",
  "selected_title": "선택된 애니메이션 제목",
  "confidence": 85,
  "reason": "제목과 시즌 정보가 정확히 일치하며, 자막판을 우선 선택했습니다."
}
```

### 매칭 실패 시:
```json
{
  "status": "no_match",
  "selected_title": null,
  "confidence": 0,
  "reason": "사용자가 요청한 '3기'에 해당하는 작품이 후보에 없습니다. 후보들은 모두 1기 또는 극장판입니다."
}
```

## 매칭 예시:

### ✅ 좋은 매칭 (자막판 우선):
- 입력: "스파이 패밀리 1기" → 후보: ["(더빙) SPY×FAMILY part 1", "(자막) SPY×FAMILY part 1"] → **(자막) SPY×FAMILY part 1** 선택 ✓
- 입력: "무직전생 1기" → 후보: ["무직전생 Part 1"] → "무직전생 Part 1" 선택 ✓

### ❌ 매칭 거부:
- 입력: "무직전생 3기" → 후보: "무직전생 Part 1, Part 2" → NO MATCH (3기 없음)
- 입력: "짱구는 못말려" → 후보: "원피스, 나루토, 드래곤볼" → NO MATCH (완전히 다른 작품)

## 중요 주의사항:
1. 확신이 없으면 매칭하지 마세요
2. 시즌/파트 번호를 정확히 확인하세요
3. **자막판이 있으면 무조건 자막판을 선택하세요**
4. 극장판과 TV 시리즈를 구분하세요
5. 유사한 제목이라도 다른 작품일 수 있습니다

사용자의 의도를 정확히 파악하고, 불확실할 때는 매칭을 거부하는 것이 더 안전합니다.
```

### **Assistant 생성 방법**
1. [OpenAI Platform](https://platform.openai.com/) 접속
2. Assistant 섹션에서 "Create" 클릭
3. 위의 시스템 프롬프트 입력
4. Model: **`gpt-4.1`** 선택 (권장)
5. Assistant ID를 `.env` 파일에 추가

## 🔧 고급 기능

### **배치 처리 관리**
```bash
# 특정 배치 상태 확인
python3 src/anime_metadata/tools/check_status.py --batch "2025-01-15_140530_my_batch"

# 실패한 항목만 재실행
python3 src/anime_metadata/tools/resume_failed.py --batch-dir productions/2025-01-15_140530_my_batch
```

### **개별 단계 실행**
```bash
# 1단계: 라프텔 검색
python3 src/anime_metadata/step1_search_candidates.py

# 2단계: OpenAI 매칭  
python3 src/anime_metadata/step2_llm_matching.py

# 3단계: 메타데이터 수집
python3 src/anime_metadata/step3_metadata_collection.py

# 4단계: 노션 업로드
python3 src/anime_metadata/step4_notion_upload.py
```

## 📈 성능 및 제한사항

### ✅ **장점**
- **높은 매칭 정확도**: OpenAI 기반 스마트 매칭
- **완전 자동화**: CSV 업로드 → 노션 완성까지 원클릭
- **기존 데이터 보호**: 이미 작성한 노션 내용은 보존
- **실패 안전성**: 일부 실패해도 전체 중단되지 않음

### ⚠️ **제한사항**  
- **라프텔 의존성**: 라프텔에 없는 애니메이션은 메타데이터 수집 불가
- **API 비용**: OpenAI API 사용량에 따른 비용 발생
- **속도**: 애니메이션 1개당 약 5-10초 소요

## 🆘 문제 해결

### **자주 발생하는 이슈**
1. **404 오류**: 노션 데이터베이스 ID가 잘못되었거나 Integration 권한 부족
2. **매칭 실패**: 애니메이션 제목이 너무 모호하거나 라프텔에 없는 경우
3. **느린 속도**: OpenAI API 응답 지연 (정상 현상)

### **해결 방법**
- 노션 Integration이 해당 데이터베이스에 접근 권한이 있는지 확인
- 애니메이션 제목을 더 명확하게 입력 (예: "리제로 3기" → "Re: 제로부터 시작하는 이세계 생활 3기")
- 배치 처리 중 중단되어도 `resume_failed.py`로 이어서 실행 가능

## 📄 라이선스

MIT License - 자유롭게 사용, 수정, 배포 가능합니다.

---

❤️ **만든 이**: 노션 덕후들을 위한 자동화 도구  
🤖 **기술 스택**: Python, OpenAI API, Laftel API, Notion API
